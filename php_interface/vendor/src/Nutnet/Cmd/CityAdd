<?php
declare(strict_types=1);
if (php_sapi_name() !== 'cli') {
    die();
}
$_SERVER['DOCUMENT_ROOT'] = \realpath(__DIR__ . '/../../../../../..');
require_once($_SERVER['DOCUMENT_ROOT'] . '/bitrix/modules/main/cli/bootstrap.php');

use Bitrix\Main\Loader;
use Bitrix\Iblock\IblockTable;



Loader::includeModule('iblock');
$iblockId = intval(IblockTable::getList([
    'filter' => [
        'CODE' => 'city',
    ],
    'select' => [
        'ID',
        'CODE',
    ],
])->fetch()['ID']);

if (!isset($argv[1])) {
    $count = 0;
    $cityFromIblock = CIBlockElement::GetList([
     
        ], [
        'IBLOCK_ID' => $iblockId, 
        ],
        false,
        false,
        [
            'ID',
            'NAME',
            'PROPERTY_phone',
    ]);
    
    $citysNameFromIblock = [];
    $citysFromFile = explode("\n", file_get_contents('resources/city.txt'));
    while ($arItem = $cityFromIblock->GetNext()) {
       array_push($citysNameFromIblock, $arItem['NAME'] );
    }
    foreach ($citysFromFile as $city) {
       if (!array_search($city, $citysNameFromIblock)) {
        $el = new CIBlockElement; 
            $el->Add([
                'IBLOCK_ID' => $iblockId,
                'NAME' => $city,
                'CODE' =>  Cutil::translit($city, 'ru'),
                'PROPERTY_VALUES' => [
                    'phone' => randPhone(),
                ]
            ]);
            echo $city . PHP_EOL;
            $count++;
       }
    }
    echo 'Городов добавлено: ' . $count . PHP_EOL;
} 
if (isset($argv[1])) {
    $cityId = CIBlockElement::GetList(
        [],
        ['NAME' => $argv[1]],
        false,
        false,
        ['ID']
    )->Fetch()['ID'];

    CIBlockElement::SetPropertyValuesEx(
        $cityId,
        $iblockId,
        ['phone' => $argv[2]]
    );

}

function randPhone() {
    $num = '8';
    for ($i = 0; $i <= 9; $i++) {
        $num .= mt_rand(0, 10);
    }
    return $num;
}